@{
    ViewBag.Title = "Waiting";
    var queueName = ViewBag.QueueName as string;
    var requestId = ViewBag.RequestId as string;
    var position = (int)ViewBag.QueuePosition;
}

<h2>Queue: @queueName</h2>
<p id="position">Your position in queue: @position</p>
<p id="length"></p>
<p>Please wait... the system will redirect you when it's your turn.</p>

<script>
    async function pollQueue() {
        try {
            const url = `/queue/checkposition/@queueName/@requestId`;
            const response = await fetch(url);
            if (!response.ok) return;

            const data = await response.json();

            document.getElementById("position").innerText = "Your position in queue: " + data.position;
            document.getElementById("length").innerText = "Current queue length: " + data.currentLength + " / " + data.maxConcurrent;

            // Server บอกว่าคุณได้คิว → redirect อัตโนมัติ
            if (data.canStart) {
                window.location.href = `/queue/process/@queueName/@requestId`;
            }
        } catch (err) {
            console.error("Polling error:", err);
        }
    }

    setInterval(pollQueue, 5000);
</script>
